/*******************************************************************************
        This module реализует the Ripemd160 algorithm by Hans Dobbertin,
        Antoon Bosselaers и Bart Preneel.

        See http://homes.esat.kuleuven.be/~bosselae/rИПemd160.html for ещё
        information.

        The implementation is based on:
        RИПEMD-160 software записано by Antoon Bosselaers,
 		available at http://www.esat.kuleuven.ac.be/~cosicart/ps/AB-9601/

*******************************************************************************/
module crypto.digest.Ripemd320;

private import crypto.digest.MerkleDamgard;
public  import crypto.digest.Digest;

/*******************************************************************************

*******************************************************************************/

final class Ripemd320 : MerkleDamgard
{
        /***********************************************************************

    	Construct a Ripemd320

     ***********************************************************************/

    this() ;

    /***********************************************************************

    	The размер of a Ripemd320 дайджест is 40 байты

     ***********************************************************************/

    override бцел размерДайджеста();


    /***********************************************************************

    	Initialize the cipher

    	Примечания:
    		Возвращает the cipher состояние в_ it's начальное значение

     ***********************************************************************/

    override проц сбрось();

    /***********************************************************************

    	Obtain the дайджест

    	Возвращает:
    		the дайджест

    	Примечания:
    		Возвращает дайджест of the текущ cipher состояние, this may be the
    		final дайджест, or a дайджест of the состояние between calls в_ обнови()

     ***********************************************************************/

    override проц создайДайджест(ббайт[] буф);


    /***********************************************************************

     	блок размер

    	Возвращает:
    	the блок размер

    	Примечания:
    	Specifies the размер (in байты) of the блок of данные в_ пароль в_
    	each вызов в_ трансформируй(). For Ripemd320 the размерБлока is 64.

     ***********************************************************************/

    protected override бцел размерБлока();

    /***********************************************************************

    	Length паддинг размер

    	Возвращает:
    	the length паддинг размер

    	Примечания:
    	Specifies the размер (in байты) of the паддинг which uses the
    	length of the данные which имеется been ciphered, this паддинг is
    	carried out by the падДлин метод. For Ripemd320 the добавьРазмер is 8.

     ***********************************************************************/

    protected бцел добавьРазмер();

    /***********************************************************************

    	Pads the cipher данные

    	Параметры:
    	данные = a срез of the cipher буфер в_ заполни with паддинг

    	Примечания:
    	Fills the passed буфер срез with the appropriate паддинг for
    	the final вызов в_ трансформируй(). This паддинг will заполни the cipher
    	буфер up в_ размерБлока()-добавьРазмер().

     ***********************************************************************/

    protected override проц падСооб(ббайт[] at);

    /***********************************************************************

    	Performs the length паддинг

    	Параметры:
    	данные   = the срез of the cipher буфер в_ заполни with паддинг
    	length = the length of the данные which имеется been ciphered

    	Примечания:
    	Fills the passed буфер срез with добавьРазмер() байты of паддинг
    	based on the length in байты of the ввод данные which имеется been
    	ciphered.

     ***********************************************************************/

    protected override проц падДлин(ббайт[] at, бдол length);

    /***********************************************************************

    	Performs the cipher on a блок of данные

    	Параметры:
    	данные = the блок of данные в_ cipher

    	Примечания:
    	The actual cipher algorithm is carried out by this метод on
    	the passed блок of данные. This метод is called for every
    	размерБлока() байты of ввод данные и once ещё with the остаток
    	данные псеп_в_конце в_ размерБлока().

     ***********************************************************************/

    protected override проц трансформируй(ббайт[] ввод);

}

/*******************************************************************************

*******************************************************************************/

debug(UnitTest)
{
    unittest
    {
        static ткст[] strings =
        [
            "",
            "a",
            "abc",
            "сообщение дайджест",
            "abcdefghijklmnopqrstuvwxyz",
            "abcdbcdecdefdefgefghfghighijhijkijkljklmklmnlmnomnopnopq",
            "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",
            "12345678901234567890123456789012345678901234567890123456789012345678901234567890"
        ];

        static ткст[] результатs =
        [
            "22d65d5661536cdc75c1fdf5c6de7b41b9f27325ebc61e8557177d705a0ec880151c3a32a00899b8",
            "ce78850638f92658a5a585097579926dda667a5716562cfcf6fbe77f63542f99b04705d6970dff5d",
            "de4c01b3054f8930a79d09ae738e92301e5a17085beffdc1b8d116713e74f82fa942d64cdbc4682d",
            "3a8e28502ed45d422f68844f9dd316e7b98533fa3f2a91d29f84d425c88d6b4eff727df66a7c0197",
            "cabdb1810b92470a2093aa6bce05952c28348cf43ff60841975166bb40ed234004b8824463e6b009",
            "d034a7950cf722021ba4b84df769a5de2060e259df4c9bb4a4268c0e935bbc7470a969c9d072a1ac",
            "ed544940c86d67f250d232c30b7b3e5770e0c60c8cb9a4cafe3b11388af9920e1b99230b843c86a4",
            "557888af5f6d8ed62ab66945c6d2a0a47ecd5341e915eb8fea1d0524955f825dc717e4a008ab2d42"
        ];

        Ripemd320 h = new Ripemd320();

        foreach (цел i, ткст s; strings)
        {
            h.обнови(cast(ббайт[]) s);
            ткст d = h.гексДайджест;

            assert(d == результатs[i],":("~s~")("~d~")!=("~результатs[i]~")");
        }


        ткст s = new сим[1000000];
        for (auto i = 0; i < s.length; i++) s[i] = 'a';
        ткст результат = "bdee37f4371e20646b8b0d862dda16292ae36f40965e8c8509e63d1dbddecc503e2b63eb9245bb66";
        h.обнови(cast(ббайт[]) s);
        ткст d = h.гексДайджест;

        assert(d == результат,":(1 million times \"a\")("~d~")!=("~результат~")");
    }

}
