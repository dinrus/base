module text.xml.DocTester;

private import exception;

private import text.xml.Document;

private import text.convert.Format;

/*******************************************************************************

        Valопрate a document

        TODO: добавь various tests here, либо in subclasses, as требуется

*******************************************************************************/

protected class DocTester(T)
{
        private alias Документ!(T) Док;         /// the typed document
        private alias Док.Узел     Узел;        /// генерный document узел

        /***********************************************************************
        
                Generate a текст представление of the document дерево

        ***********************************************************************/
        
        final проц оцени (Док doc)
        {     
                оцени (doc.элементы);  
        }
        
        /***********************************************************************
        
                Generate a представление of the given узел-subtree 

        ***********************************************************************/
        
        final проц оцени (Узел узел)
        {
                switch (узел.ид)
                       {
                       case ПТипУзлаРЯР.Документ:
                            foreach (n; узел.ветви)
                                     оцени (n);
                            break;
        
                       case ПТипУзлаРЯР.Элемент:
                            элемент (узел);

                            foreach (n; узел.атрибуты)
                                     атрибут (n);

                            foreach (n; узел.ветви)
                                     оцени (n);
                            break;
        
                       case ПТипУзлаРЯР.Атрибут:
                            атрибут (узел);
                            break;
        
                       case ПТипУзлаРЯР.Данные:
                            данные (узел);
                            break;
        
                       case ПТипУзлаРЯР.Комментарий:
                            коммент (узел);
                            break;
        
                       case ПТипУзлаРЯР.ПИ:
                            pi (узел);
                            break;
                
                       case ПТипУзлаРЯР.СиДанные:
                            cdata (узел);
                            break;
                
                       case ПТипУзлаРЯР.Доктип:
                            doctype (узел);
                            break;
                       }
        }

        /***********************************************************************
        
                оцени an элемент

        ***********************************************************************/
        
        проц элемент (Узел узел)
        {
                uniqueAttrNames (узел);
        }

        /***********************************************************************
        
                оцени an атрибут

        ***********************************************************************/
        
        проц атрибут (Узел узел)
        {
        }

        /***********************************************************************
        
                оцени a данные узел

        ***********************************************************************/
        
        проц данные (Узел узел)
        {
        }

        /***********************************************************************
        
                оцени a коммент узел

        ***********************************************************************/
        
        проц коммент (Узел узел)
        {
        }

        /***********************************************************************
        
                оцени a pi узел

        ***********************************************************************/
        
        проц pi (Узел узел)
        {
        }

        /***********************************************************************
        
                оцени a cdata узел

        ***********************************************************************/
        
        проц cdata (Узел узел)
        {
        }

        /***********************************************************************
        
                оцени a doctype узел

        ***********************************************************************/
        
        проц doctype (Узел узел)
        {
        }

        /***********************************************************************
        
                Ensure атрибут names are unique внутри the элемент 

        ***********************************************************************/
        
        static проц uniqueAttrNames (Узел узел)
        {
                T[128]  name1 =void,
                        name2 =void;

                // non-optimal, but is it critical?
                foreach (атр; узел.атрибуты)
                        {
                        auto имя = атр.имя (name1);
                        auto следщ = атр.nextSibling;
                        while (следщ !is пусто)
                              {
                              if (имя == следщ.имя(name2))
                                  ошибка ("дубликат атрибут имя '{}' for элемент '{}'", 
                                          имя, узел.имя(name2));
                              следщ = атр.nextSibling;
                              }
                        }
        }

        /***********************************************************************
        
                остановись validation

        ***********************************************************************/
        
        static проц ошибка (ткст форматируй, ...)
        {
                throw new TextException (Формат.преобразуй(_arguments, _argptr, форматируй));
        }
}




/*******************************************************************************

*******************************************************************************/

debug (DocTester)
{
        проц main()
        {
                auto знач = new DocTester!(сим);
        }
}
