module lib.curl;
//the equiv to curl.h.... But only adding what i need.
import dinrus, stringz;

alias ук ЦУРЛ;

const цел ЦУРЛОШ_ОК = 0;
const цел ЦУРЛОШ_РАЗМ = 256;

enum ПОпцияЦурл : цел {
	БезПрогресса = 43,
	ПадениеПриОш = 45,
	СледуйЛокации = 52,
	Файл = 10001,
	ПишиДанные = 10001,
	Урл = 10002,
	ОшБуфер = 10010,
	АгентПользователя = 10018,
	ПишиЗаг = 10029,
	ПишиФункцию = 20011,
	ФункцияПрогресса = 20056,
	ФункцияЗага = 20079
}

extern(C)
{
	ЦУРЛ* function() цурл_легко_иниц;
	проц function(ЦУРЛ* укз) цурл_легко_очисть;
	цел function(ЦУРЛ* укз, ПОпцияЦурл опц, ...) цурл_легко_устопц;
	цел function(ЦУРЛ* укз) цурл_легко_выполни;
	char* function() цурл_версия;
}
проц грузи(Биб биб)
{
    вяжи(цурл_версия)("curl_version", биб);
	вяжи(цурл_легко_иниц)("curl_easy_init", биб);
	вяжи(цурл_легко_очисть)("curl_easy_cleanup", биб);
	вяжи(цурл_легко_устопц)("curl_easy_setopt", биб);
	вяжи(цурл_легко_выполни)("curl_easy_perform", биб);
}
/////////////////////////////////////////////////////
ЖанБибгр ЦурлЗагр;

	static this()
	{
		ЦурлЗагр.заряжай("DinrusCurlX86.dll", &грузи );
		ЦурлЗагр.загружай();
	}

	static ~this()
	{
		ЦурлЗагр.выгружай();
	}
////////////////////////////////////////////////////	
private enum ПРежимЦурл { Ткст, Файл }

class ЦурлИскл : Искл {
	this(ткст msg) ;
	
}

//the main class for easy curl. may be renamed in the future.
class Цурл {
	ЦУРЛ* м_цурл;
	ткст м_последнОш;
	цел м_последнКодЦурл;
	ткст[] м_полученныеЗаги;
	бул myFollowLocation;
	ткст м_буфер;
	ПРежимЦурл м_режим;
	Файл м_файл;
	ткст м_имяф;

	public ткст[] дайЗаги();

	this();
	~this();

	public ткст дайТкст(ткст урл);
	public проц дайФайл(ткст урл, ткст имяф) ;
	private проц очистьБуферы();
	private бул устОпц(ПОпцияЦурл опция, ткст ткт);
	private бул устОпц(ПОпцияЦурл опция, ук prarm) ;
	private бул устОпц(ПОпцияЦурл опция, цел prarm);

	//Call backs.
	private extern (C) static т_мера headerCallback( ук укз, т_мера разм , т_мера колво_членов, ук объ );
	private extern (C) static т_мера writeCallback( ук укз, т_мера разм , т_мера колво_членов, ук объ ) ;

	
}

unittest{

	void main() {
		try {
			скажифнс("Проверка DinrusCurlX86 версии %s...", stringz.изТкст0(цурл_версия));
			Цурл ц = new Цурл();
			ц.дайФайл("http://google.com", "google.html");
			скажинс("Заголовки:");
			ткст[] заги = ц.дайЗаги();
			foreach (ткст заг; заги) {
				скажифнс("\t%s", заг);
			}
		} catch (Искл e) {
			скажифнс("Впоймано: %s", e.сооб);
		}
		пз;
	}
}
