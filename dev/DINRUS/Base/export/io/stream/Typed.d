/*******************************************************************************

        Потоки, представляющие простые исконные типы как дискретные элементы.
		Ввод/вывод буферируются и должны yield fair performance.

*******************************************************************************/

module io.stream.Typed;

private import io.device.Conduit;

private import io.stream.Buffered;

/*******************************************************************************

        Тип T - это целевой тип или тип назначения.

*******************************************************************************/

class ТипированныйВвод(T) : ФильтрВвода
{
    /***********************************************************************

    ***********************************************************************/

    this (ИПотокВвода поток)
    {
        super (Бввод.создай (поток));
    }

    /***********************************************************************

            Перписывает this, выдавая полезную ссылку-сцепку.

    ***********************************************************************/

    final override ТипированныйВвод слей ()
    {
        super.слей;
        return this;
    }

    /***********************************************************************

            Читает значение из потока. Возвращает нет, когда весь
            контент потреблён.

    ***********************************************************************/

    final бул читай (ref T x)
    {
        return исток.читай((&x)[0..1]) is T.sizeof;
    }

    /***********************************************************************

            Итерирует по всему контенту.

    ***********************************************************************/

    final цел opApply (цел delegate(ref T x) дг)
    {
        T x;
        цел возвр;

        while ((исток.читай((&x)[0..1]) is T.sizeof))
            if ((возвр = дг (x)) != 0)
                break;
        return возвр;
    }
}



/*******************************************************************************

         Тип T - это целевой тип или тип назначения.

*******************************************************************************/

class ТипированныйВывод(T) : ФильтрВывода
{
    /***********************************************************************

    ***********************************************************************/

    this (ИПотокВывода поток)
    {
        super (Бвыв.создай (поток));
    }

    /***********************************************************************

            Прикрепить значение к потоку вывода.

    ***********************************************************************/

    final проц пиши (ref T x)
    {
        сток.пиши ((&x)[0..1]);
    }
}


/*******************************************************************************

*******************************************************************************/

debug (UnitTest)
{
    import io.Stdout;
    import io.stream.Utf;
    import io.device.Array;

    unittest
    {
        Массив вывод;

        auto inp = new ТипированныйВвод!(сим)(new Массив("hello world"));
        auto oot = new ТипированныйВывод!(сим)(вывод = new Массив(20));

        foreach (x; inp)
        oot.пиши (x);
        assert (вывод.срез == "hello world");

        auto xx = new ТипированныйВвод!(сим)(new ЮВвод!(сим, дим)(new Массив("hello world"d)));
        ткст yy;
        foreach (x; xx)
        yy ~= x;
        assert (yy == "hello world");
    }
}
