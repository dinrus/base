/*******************************************************************************

        copyright:      Copyright (c) 2007 Kris Bell. Все права защищены

        license:        BSD стиль: $(LICENSE)

        version:        Jan 2007 : начальное release
        
        author:         Kris 

*******************************************************************************/

module io.protocol.NativeProtocol;

private import  io.Buffer;

private import  io.protocol.model;

/*******************************************************************************

*******************************************************************************/


export class ПротоколНатив : ИПротокол
{


        protected бул          префикс_;
        protected ИБуфер       буфер_;

        /***********************************************************************

        ***********************************************************************/
export:
        this (ИПровод провод, бул префикс=да)
        {
                this.префикс_ = префикс;

                auto b = cast(ИБуферированный) провод;
                буфер_ = b ? b.буфер() : объБуфер(провод);
        }

        /***********************************************************************

        ***********************************************************************/

        ИБуфер буфер ()
        {
                return  буфер_;
        }

        /***********************************************************************

        ***********************************************************************/

        проц[] читай (ук приёмн, бцел байты, Тип тип)
        {
                return буфер_.читайРовно (приёмн, байты);
        }
        
        /***********************************************************************

        ***********************************************************************/

        проц пиши (ук ист, бцел байты, Тип тип)
        {
                буфер_.добавь (ист, байты);
        }
        
        /***********************************************************************

        ***********************************************************************/

        проц[] читайМассив (ук приёмн, бцел байты, Тип тип, Разместитель размести)
        {
                if (префикс_)
                   {
                   читай (&байты, байты.sizeof, Тип.UInt);
                   return размести (&читай, байты, тип); 
                   }

                return читай (приёмн, байты, тип);
        }
        
        /***********************************************************************

        ***********************************************************************/

        проц пишиМассив (ук ист, бцел байты, Тип тип)
        {
                if (префикс_)
                    пиши (&байты, байты.sizeof, Тип.UInt);

                пиши (ист, байты, тип);
        }
}



/*******************************************************************************

*******************************************************************************/

debug (UnitTest)
{
        import io.Buffer;
        import io.protocol.Writer;
        import io.protocol.Reader;
        import io.protocol.NativeProtocol;
        
        unittest
        {
                auto протокол = new ПротоколНатив (new Буфер(32));
                auto ввод  = new Читатель (протокол);
                auto вывод = new Писатель (протокол);

                ткст foo;
                вывод ("testing testing 123"c);
                ввод (foo);
                assert (foo == "testing testing 123");
        }
}

   